<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>Reveal.js Markdown Slide</title>
    <meta name="description" content="perform a slide with markdown out of the box">
    <meta name="author" content="NCUTEA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="./revealjs/css/reveal.css">
    <link rel="stylesheet" href="./revealjs/css/theme/black.css" id="theme">
    <link rel="stylesheet" href="./revealjs/lib/css/zenburn.css">

    <link rel="stylesheet" href="./plugins/reveal.js-plugins/menu/font-awesome-4.3.0/css/font-awesome.min.css">
    <script>
        let link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? './revealjs/css/print/pdf.css' : './revealjs/css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="./revealjs/lib/js/html5shiv.js"></script>
    <![endif]-->

    <!-- ruleJS -->
    <script src="./plugins/reveal.js-plugins/spreadsheet/ruleJS.all.full.min.js"></script>
    <link rel="stylesheet" href="./plugins/reveal.js-plugins/spreadsheet/spreadsheet.css">
</head>

<body>
<div class="reveal">
    <div class="slides">

        <section id="select-file-page">
            <a href="javascript:window.file.click()"><h3>点击选择 Markdown 文件</h3></a>
            <input type="file" id="file" accept="text/*" style="display: none"/>
        </section>

        <section mdslide="" data-markdown=""
                 data-separator="^===$"
                 data-separator-vertical="^---$"
                 data-separator-notes="^Note:"
                 data-charset="utf-8">
        </section>

    </div>

</div>

<script src="./revealjs/lib/js/head.min.js"></script>
<script src="./revealjs/js/reveal.js"></script>

<script>

    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        mouseWheel: true,
        previewLinks: true,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'slide', // none/fade/slide/convex/concave/zoom
        slideNumber: false,
        markdown: {
            smartypants: true
        },
        pdfExportShortcut: 'E',
        menu: {
            side: 'left',
            width: 'normal',
            numbers: false,
            titleSelector: 'h1, h2, h3, h4, h5, h6',
            useTextContentForMissingTitles: false,
            hideMissingTitles: false,
            markers: true,
            custom: [
                // {title: 'Plugins', icon: '<i class="fa fa-external-link"></i>', src: 'toc.html'},
                // {title: 'About', icon: '<i class="fa fa-info"></i>', src: 'about.html'}
            ],
            themes: false,
            themesPath: 'css/theme/',
            transitions: false,
            openButton: true,
            openSlideNumber: false,
            keyboard: true,
            sticky: false,
            autoOpen: true,
            delayInit: false,
            openOnInit: false,
            loadIcons: false,
        },
        toolbar: {
            position: 'bottom',
            fullscreen: true,
            overview: false,
            pause: false,
            notes: true,
            help: true,
            custom: [
                {
                    icon: "fa-file", callback: function () {
                        window.file.click()
                    }
                }
            ],
            captureMenu: true,
            capturePlaybackControl: true,
            loadIcons: false
        },
        chalkboard: { // font-awesome.min.css must be available
            src: null,
            toggleChalkboardButton: {left: "45px", bottom: "80px"},
            toggleNotesButton: {left: "85px", bottom: "80px"},
        },
        coursemod: {
            enabled: true,
            shown: false
        },
        spreadsheet: {
            fontsize: 24,
            width: 150,
            delimiter: ",",
            precision: 4 // the maximum number of digits after the comma
        },


        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
            {
                src: './revealjs/lib/js/classList.js', condition: function () {
                    return !document.body.classList;
                }
            },
            {
                src: './revealjs/plugin/markdown/marked.js', condition: function () {
                    return !!document.querySelector('[data-markdown]');
                }
            },
            {
                src: './revealjs/plugin/markdown/markdown.js', condition: function () {
                    return !!document.querySelector('[data-markdown]');
                }
            },
            {
                src: './revealjs/plugin/highlight/highlight.js', async: true, callback: function () {
                    hljs.initHighlightingOnLoad();
                }
            },
            {src: './revealjs/plugin/search/search.js', async: true},
            {src: './revealjs/plugin/zoom-js/zoom.js', async: true},
            {src: './revealjs/plugin/notes/notes.js', async: true},
            {src: './revealjs/plugin/math/math.js', async: true},
            {src: './plugins/reveal.js-coursemod/coursemod/coursemod.js', async: true},
            {src: './plugins/reveal-pdfexport/pdfexport.js', async: true},
            {src: './plugins/reveal.js-plugins/chalkboard/chalkboard.js'},
            {src: './plugins/reveal.js-menu/menu.js'},
            {src: './plugins/reveal.js-toolbar/toolbar.js'},
            {src: './plugins/reveal.js-plugins/spreadsheet/spreadsheet.js'},
            {src: './plugins//reveal.js-plugins/chart/Chart.min.js'},
            {src: './plugins/reveal.js-plugins/chart/csv2chart.js'},
        ],

        keyboard: {
            67: function () {
                RevealChalkboard.toggleNotesCanvas()
            },	// toggle chalkboard when 'c' is pressed
            66: function () {
                RevealChalkboard.toggleChalkboard()
            },	// toggle chalkboard when 'b' is pressed
            46: function () {
                RevealChalkboard.clear()
            },	// clear chalkboard when 'DEL' is pressed
            8: function () {
                RevealChalkboard.reset()
            },	// reset all chalkboard data when 'BACKSPACE' is pressed
            68: function () {
                RevealChalkboard.download()
            },	// downlad chalkboard drawing when 'd' is pressed
        },
    });

</script>

<script>

    window.LAST_MD_KEY = "mdsilde-last-md";
    window.LAST_URL_KEY = "mdsilde-last-url";

    function reloadMarkdown(arg = {"url": null, "md": null}) {

        let mdSlide = document.querySelector('[mdslide]');

        localStorage.removeItem(window.LAST_MD_KEY);
        localStorage.removeItem(window.LAST_URL_KEY);

        if (arg.url && arg.url !== undefined) {
            localStorage.setItem(window.LAST_URL_KEY, arg.url);
            mdSlide.setAttribute('data-markdown', arg.url);
        } else if (arg.md && arg.md !== undefined) {
            localStorage.setItem(window.LAST_MD_KEY, arg.md);
            mdSlide.setAttribute('data-markdown', '');
            mdSlide.innerHTML = "<textarea  data-template>" + arg.md + "</textarea>";
        }
        mdSlide.setAttribute('data-separator', "^===$");
        mdSlide.setAttribute('data-separator-vertical', "^---$");
        mdSlide.setAttribute('data-separator-notes', "^Note:");
        mdSlide.setAttribute('data-charset', "utf-8");

        RevealMarkdown.initialize();

        // refresh reveal
        Reveal.next()
        // Reveal.toggleOverview();
        // Reveal.toggleOverview();
    }


    function getQuery(name) {
        const reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        const r = window.location.search.substr(1).match(reg);
        if (r != null) return r[2];
        return null;
    }

    window.onload = function () {

        let input = document.getElementById("file");
        input.addEventListener("change", loadContent);

        function loadContent(event) {
            let file = event.target.files[0];
            let reader = new FileReader();
            reader.onload = function (e) {
                reloadMarkdown({"md": reader.result})
            };
            reader.onerror = function (err) {
                console.log(err, err.loaded, err.loaded === 0, file);
            };
            reader.readAsText(file);
        }

        // 从 queryString/localStorage 读取 markdown 文件
        // url跳转 queryString 与临时读取的md丢失，无法读取，使用 localStorage 存储上次的数据
        let url = getQuery("url");
        if (url === null) {
            console.log("从querystring读取到url失败");
            url = localStorage.getItem(window.LAST_URL_KEY);
        }

        if (url !== null) {
            console.log("读取到url:" + url);
            reloadMarkdown({"url": url});
        }
        else {
            let md = localStorage.getItem(window.LAST_MD_KEY);
            if (md !== null) {
                console.log("从localStorage读取到md:" + md);
                reloadMarkdown({"md": md});
            }
        }

        // tmp fix
        document.getElementsByClassName("fas fa-bars")[0].className = "fa fa-bars";

    }
</script>

</body>
</html>
